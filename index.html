<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEARTMAN: Hug Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #ff1493;
            --secondary: #00d4ff;
            --accent: #ff006e;
            --dark-bg: #0a0e27;
            --darker-bg: #050810;
            --neon-pink: #ff007f;
            --neon-cyan: #00ffff;
            --neon-purple: #b300ff;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0033 50%, var(--darker-bg) 100%);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Fredoka One', sans-serif;
            color: #fff;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: radial-gradient(ellipse at 50% 50%, rgba(255, 20, 147, 0.1) 0%, transparent 70%);
        }
        
        canvas {
            box-shadow: 
                0 0 30px rgba(255, 0, 127, 0.4),
                0 0 60px rgba(0, 212, 255, 0.2),
                inset 0 0 30px rgba(255, 0, 127, 0.1);
            border-radius: 8px;
            border: 2px solid var(--neon-pink);
            max-width: 100%;
            max-height: 85vh;
            background: #000;
            display: block;
        }
        
        .ui-layer {
            width: 100%;
            max-width: 560px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            box-sizing: border-box;
            z-index: 10;
            font-family: 'Press Start 2P', monospace;
            font-size: 11px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-cyan);
            background: rgba(10, 14, 39, 0.6);
            border-radius: 8px;
            margin-top: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 127, 0.3);
        }
        
        .ui-layer > div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .score-label {
            color: var(--neon-pink);
            text-shadow: 0 0 10px var(--neon-pink);
        }
        
        #score-el {
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }
        
        .goal-label {
            color: var(--neon-purple);
            text-shadow: 0 0 10px var(--neon-purple);
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Start Screen */
        #start-screen {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 0, 51, 0.95) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 0, 127, 0.2);
        }
        
        #start-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .title-container {
            text-align: center;
            margin-bottom: 20px;
            animation: titleGlow 2s ease-in-out infinite;
        }
        
        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink); }
            50% { text-shadow: 0 0 20px var(--neon-pink), 0 0 40px var(--neon-cyan), 0 0 60px var(--neon-pink); }
        }
        
        .title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 900;
            color: var(--neon-pink);
            letter-spacing: 4px;
            line-height: 1.1;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .title-sub {
            font-family: 'Fredoka One', sans-serif;
            font-size: clamp(0.8rem, 3vw, 1.2rem);
            color: var(--neon-cyan);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 32px;
        }
        
        #start-btn {
            position: relative;
            padding: 16px 32px;
            background: transparent;
            border: 3px solid var(--neon-pink);
            color: var(--neon-pink);
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.3);
            overflow: hidden;
            margin-bottom: 32px;
        }
        
        #start-btn:hover {
            background: rgba(255, 0, 127, 0.2);
            color: #fff;
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.6), 0 0 60px rgba(0, 212, 255, 0.3);
            transform: scale(1.05);
        }
        
        .instructions {
            margin-top: 24px;
            text-align: center;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            letter-spacing: 1px;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
            line-height: 1.8;
        }
        
        .instruction-item {
            margin: 8px 0;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .instruction-item:nth-child(2) { animation-delay: 0.3s; }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Finale Screen */
        #finale-screen {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.95) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease;
            backdrop-filter: blur(8px);
        }
        
        #finale-screen.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .heart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .heart-emoji {
            font-size: clamp(4rem, 15vw, 8rem);
            position: absolute;
            transition: all 1s ease;
            filter: drop-shadow(0 0 20px rgba(255, 0, 127, 0.5));
        }
        
        #final-heart { left: 15%; animation: heartFloat 3s ease-in-out infinite; }
        #final-partner { right: 15%; opacity: 0.4; animation: partnerFloat 3s ease-in-out infinite; animation-delay: 0.5s; }
        #final-hug { opacity: 0; transform: scale(0.5); animation: hugAppear 1s ease-out forwards 1.5s, hugPulse 1s ease-in-out infinite 2.5s; }
        
        @keyframes heartFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        @keyframes partnerFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        @keyframes hugAppear { to { opacity: 1; transform: scale(1); } }
        @keyframes hugPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .finale-text {
            text-align: center;
            opacity: 0;
            transition: opacity 1s ease;
            animation: fadeInText 1s ease-out forwards 2.5s;
        }
        
        @keyframes fadeInText { to { opacity: 1; } }
        
        .finale-quote {
            font-family: 'Fredoka One', sans-serif;
            font-size: clamp(1rem, 4vw, 1.4rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 20px var(--neon-cyan);
            line-height: 1.6;
            margin-bottom: 24px;
            font-style: italic;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .finale-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.8rem, 3vw, 1.2rem);
            color: var(--neon-pink);
            text-shadow: 0 0 20px var(--neon-pink);
            letter-spacing: 2px;
            margin-bottom: 24px;
            text-transform: uppercase;
        }
        
        .finale-btn {
            padding: 12px 24px;
            border: 2px solid var(--neon-pink);
            background: transparent;
            color: var(--neon-pink);
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            letter-spacing: 1px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(255, 0, 127, 0.3);
        }
        
        .finale-btn:hover {
            background: var(--neon-pink);
            color: #000;
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.6);
            transform: scale(1.05);
        }
        
        @media (max-width: 600px) {
            .ui-layer { font-size: 9px; padding: 10px 16px; gap: 12px; }
            canvas { border-radius: 6px; border-width: 1px; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-layer">
        <div>
            <span class="score-label">SCORE:</span>
            <span id="score-el">0</span>
        </div>
        <div>
            <span class="goal-label">TARGET: 450</span>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="start-screen">
        <div class="title-container">
            <div class="title-main">HEART<br>MAN</div>
            <div class="title-sub">‚ù§Ô∏è HUG DAY SPECIAL ‚ù§Ô∏è</div>
        </div>
        
        <div id="enemies-display" style="margin: 20px 0; text-align: center; font-family: 'Press Start 2P', monospace; font-size: 9px; color: #00d4ff; text-shadow: 0 0 10px #00d4ff;"></div>
        
        <button id="start-btn">INSERT COIN & PLAY MUSIC</button>
        
        <div class="instructions">
            <div class="instruction-item">‚ù§Ô∏è = LOVE (COLLECT)</div>
            <div class="instruction-item">üéÆ SWIPE TO MOVE</div>
            <div class="instruction-item">üëª AVOID GLOOMS</div>
            <div class="instruction-item">üíó 4 POWERUPS ONLY!</div>
        </div>
    </div>

    <div id="finale-screen">
        <div class="heart-container">
            <div id="final-heart" class="heart-emoji">‚ù§Ô∏è</div>
            <div id="final-partner" class="heart-emoji">üë§</div>
            <div id="final-hug" class="heart-emoji">ü´Ç</div>
        </div>
        
        <div class="finale-text">
            <p class="finale-quote">
                "No matter how bad the situations are, love always finds a way.<br>I love your hugs. You're the best."
            </p>
            <h2 class="finale-title">HAPPY HUG DAY!</h2>
            <button class="finale-btn" onclick="location.reload()">REPLAY FOREVER</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-el');
    const startScreen = document.getElementById('start-screen');
    const finaleScreen = document.getElementById('finale-screen');

    // --- CONFIGURATION ---
    const width = 28;
    const TILE_SIZE = 20;
    // Standard Pacman Layout
    const layout = [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,3,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,4,4,4,4,4,4,4,4,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,2,2,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        4,4,4,4,4,4,0,0,0,4,1,2,2,2,2,2,2,1,4,0,0,0,4,4,4,4,4,4,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,3,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
    ];

    let squares = [];
    let score = 0;
    let gameActive = false;
    let musicAudio = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Tours/Enthusiast/Tours_-_01_-_Enthusiast.mp3');
    musicAudio.loop = true;
    musicAudio.volume = 0.4;
    
    let pacman = { index: 490, dir: 1, nextDir: 1, rot: 0 };
    let currentSessionQuotes = [];

    // --- ROMANTIC QUOTE POOL (20+) ---
    const allQuotes = [
        "Imagine me grabbing your bum while we kiss",
        "Imagine us kissing in the rain on the rooftop of our house",
        "Imagine us cuddling together in a thunderstorm under a blanket",
        "I want to wake up next to you every single day",
        "Your laugh is my favorite sound in the world",
        "You are my safe space",
        "Every love song is about you now",
        "I‚Äôd choose you in a hundred lifetimes",
        "Imagine us cooking dinner together dancing to jazz",
        "You make the gloomy days sunny",
        "I am so addicted to you",
        "Imagine us holding hands walking down an old street",
        "My heart beats faster whenever you are near",
        "You are the best thing that ever happened to me",
        "I love you more than pizza (and that says a lot)",
        "Imagine a lazy Sunday morning just tangled in sheets",
        "You are my home",
        "I just want to hold you tight and never let go",
        "Even when I'm angry, I still love you",
        "Imagine us growing old and still flirting",
        "You're the peanut butter to my jelly",
        "I love it when you smile at me",
        "Imagine late night drives with your hand in mine"
    ];

    // Shuffle and pick 4
    function shuffleQuotes() {
        let shuffled = [...allQuotes].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 4);
    }
    
    // Updated Ghost Definitions
    // Speeds increased slightly for "Hunting"
    let ghosts = [
        { name: 'blinky', index: 348, speed: 130, timer: 0, scared: false, start: 348, currentDir: -1, color: '#ff1744', displayName: 'STRESS', icon: 'üò°' },
        { name: 'pinky', index: 376, speed: 180, timer: 0, scared: false, start: 376, currentDir: -1, color: '#ff6ec7', displayName: 'ANXIETY', icon: 'üò∞' },
        { name: 'inky', index: 351, speed: 220, timer: 0, scared: false, start: 351, currentDir: 1, color: '#9c27b0', displayName: 'DOUBT', icon: 'üòµ‚Äçüí´' },
        { name: 'clyde', index: 379, speed: 280, timer: 0, scared: false, start: 379, currentDir: 1, color: '#00bcd4', displayName: 'LONELINESS', icon: 'ü•∫' }
    ];
    
    function displayEnemiesOnTitle() {
        const enemiesDisplay = document.getElementById('enemies-display');
        if (!enemiesDisplay) return;
        let html = '<div style="margin-bottom: 12px; letter-spacing: 2px; color: #ff007f;">THE GLOOMS:</div>';
        ghosts.forEach(g => {
            html += `<div style="margin: 5px 0; color: ${g.color}; text-shadow: 0 0 8px ${g.color}; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 14px;">${g.icon}</span> <span>${g.displayName}</span>
                     </div>`;
        });
        enemiesDisplay.innerHTML = html;
    }

    displayEnemiesOnTitle();
    
    function init() {
        const availableHeight = window.innerHeight * 0.8;
        const availableWidth = window.innerWidth * 0.95;
        let scale = Math.min(availableWidth / (width * TILE_SIZE), availableHeight / (width * TILE_SIZE));
        canvas.width = width * TILE_SIZE * scale;
        canvas.height = width * TILE_SIZE * scale;
        ctx.scale(scale, scale);
        
        // Randomize quotes for this session
        currentSessionQuotes = shuffleQuotes();
        
        drawBoard();
    }

    function getCoordinates(index) {
        return { x: index % width, y: Math.floor(index / width) };
    }

    function getDistance(idx1, idx2) {
        const c1 = getCoordinates(idx1);
        const c2 = getCoordinates(idx2);
        return Math.sqrt(Math.pow(c1.x - c2.x, 2) + Math.pow(c1.y - c2.y, 2));
    }

    function gameLoop() {
        if (!gameActive) return;

        // --- PACMAN MOVEMENT ---
        let nextMove = pacman.index + pacman.nextDir;
        if(layout[nextMove] !== 1 && layout[nextMove] !== 2) {
            pacman.dir = pacman.nextDir;
        }
        let moveIdx = pacman.index + pacman.dir;
        
        if (layout[moveIdx] !== 1 && layout[moveIdx] !== 2) {
            pacman.index = moveIdx;
        }

        if(pacman.index === 392) pacman.index = 419;
        else if(pacman.index === 419) pacman.index = 392;

        if (layout[pacman.index] === 0 && !squares[pacman.index]) {
            score++;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
        } else if (layout[pacman.index] === 3 && !squares[pacman.index]) {
            score += 50;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
            
            // Pop a quote
            if(currentSessionQuotes.length > 0) {
                showHugQuote(currentSessionQuotes.pop());
            } else {
                showHugQuote("I love you!");
            }
            
            ghosts.forEach(g => g.scared = true);
            setTimeout(() => ghosts.forEach(g => g.scared = false), 10000);
            if(navigator.vibrate) navigator.vibrate(20);
        }

        // Increased Goal for harder difficulty
        if (score >= 450) { endGame(true); return; }

        // --- IMPROVED GHOST AI (HUNTING) ---
        ghosts.forEach(ghost => {
            ghost.timer++;
            // Move faster (lower threshold)
            let moveThreshold = ghost.scared ? 12 : (ghost.name === 'blinky' ? 4 : 6); 
            
            if (ghost.timer > moveThreshold) {
                ghost.timer = 0;
                
                const possibleMoves = [-1, 1, -width, width];
                let validMoves = possibleMoves.filter(dir => {
                    let next = ghost.index + dir;
                    if(layout[next] === 1) return false;
                    if (!ghost.scared && dir === -ghost.currentDir) return false;
                    return true;
                });

                if(validMoves.length === 0) {
                     validMoves = possibleMoves.filter(dir => {
                        let next = ghost.index + dir;
                        return layout[next] !== 1;
                     });
                }

                if (validMoves.length > 0) {
                    let bestDir = validMoves[Math.floor(Math.random() * validMoves.length)];
                    
                    if (!ghost.scared) {
                        // HUNTING LOGIC
                        let target = pacman.index;
                        
                        // Pinky tries to ambush (4 tiles ahead)
                        if (ghost.name === 'pinky') {
                            // Boundary checks ignored for simplicity in grid math
                             target = pacman.index + (pacman.dir * 4);
                        }
                        
                        // Clyde scatters if too close (8 tiles)
                        if (ghost.name === 'clyde') {
                            if(getDistance(ghost.index, pacman.index) < 8) {
                                target = 0; // Go to corner
                            }
                        }

                        // Aggressive Pathfinding for everyone except scared
                        let minDst = Infinity;
                        validMoves.forEach(dir => {
                            let dst = getDistance(ghost.index + dir, target);
                            if (dst < minDst) { minDst = dst; bestDir = dir; }
                        });
                    } else {
                        // FEAR LOGIC: Pick move furthest from Pacman
                        let maxDst = -1;
                        validMoves.forEach(dir => {
                            let dst = getDistance(ghost.index + dir, pacman.index);
                            if (dst > maxDst) { maxDst = dst; bestDir = dir; }
                        });
                    }
                    
                    ghost.currentDir = bestDir;
                    ghost.index += bestDir;
                }

                if (ghost.index === pacman.index) {
                    if (ghost.scared) ghost.index = ghost.start;
                    else endGame(false);
                }
            }
        });

        drawBoard();
        setTimeout(() => requestAnimationFrame(gameLoop), 50); 
    }

    function drawBoard() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width*TILE_SIZE, width*TILE_SIZE);
        
        layout.forEach((cell, i) => {
            let x = (i % width) * TILE_SIZE;
            let y = Math.floor(i / width) * TILE_SIZE;
            
            if (cell === 1) { 
                ctx.fillStyle = '#1a1a3e';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#334155';
                ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE);
                ctx.strokeStyle = '#ff007f';
                ctx.lineWidth = 1;
                ctx.strokeRect(x+5,y+5,TILE_SIZE-10,TILE_SIZE-10);
            } else if (cell === 0 && !squares[i]) { 
                ctx.fillStyle = '#fbcfe8';
                ctx.beginPath();
                ctx.arc(x+10, y+10, 2, 0, Math.PI*2);
                ctx.fill();
            } else if (cell === 3 && !squares[i]) { 
                ctx.fillStyle = '#ff007f';
                ctx.shadowColor = '#ff007f';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(x+10, y+10, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        });

        // DRAW HEARTMAN
        let px = (pacman.index % width) * TILE_SIZE + 10;
        let py = Math.floor(pacman.index / width) * TILE_SIZE + 10;
        ctx.save();
        ctx.translate(px, py);
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ff3366';
        ctx.font = "20px 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText('‚ù§Ô∏è', 0, 2);
        ctx.restore();

        // DRAW GLOOMS
        ghosts.forEach(g => {
            let gx = (g.index % width) * TILE_SIZE + 10;
            let gy = Math.floor(g.index / width) * TILE_SIZE + 10;
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = g.color;
            ctx.font = "20px 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            // If scared, turn into Invisible Emoji
            let emoji = g.scared ? 'ü´•' : g.icon;
            ctx.fillText(emoji, gx, gy + 2);
            ctx.shadowBlur = 0;
        });
    }

    // Popup Logic - Moved to Top
    function showHugQuote(text) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 80px; left: 50%; transform: translate(-50%, 0);
            background: rgba(255, 0, 127, 0.95); color: #fff; padding: 15px 20px;
            border-radius: 8px; font-family: 'Fredoka One', sans-serif; font-size: 13px;
            text-align: center; z-index: 100; box-shadow: 0 0 30px rgba(255, 0, 127, 0.6);
            border: 2px solid #ff007f; max-width: 90%; animation: quoteAppear 0.5s ease-out;
            pointer-events: none;
        `;
        notification.innerHTML = '‚ú® ' + text + ' ‚ú®';
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'quoteDisappear 0.5s ease-out forwards';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    function endGame(win) {
        gameActive = false;
        if(win) {
            finaleScreen.classList.add('active');
            setTimeout(() => {
                document.getElementById('final-heart').style.opacity = '1';
                document.getElementById('final-partner').style.opacity = '0.4';
                document.getElementById('final-hug').style.opacity = '1';
                if(navigator.vibrate) navigator.vibrate([100,50,100]);
            }, 500);
        } else {
            document.body.style.backgroundColor = '#330000';
            setTimeout(() => { 
                alert("Caught by the Glooms! Love is tough, try again."); 
                location.reload(); 
            }, 100);
        }
    }

    document.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft' || e.key === 'a') pacman.nextDir = -1;
        if(e.key === 'ArrowRight' || e.key === 'd') pacman.nextDir = 1;
        if(e.key === 'ArrowUp' || e.key === 'w') pacman.nextDir = -width;
        if(e.key === 'ArrowDown' || e.key === 's') pacman.nextDir = width;
    });

    let tsX, tsY;
    document.addEventListener('touchstart', e => { tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; }, {passive: false});
    document.addEventListener('touchend', e => {
        let dx = e.changedTouches[0].clientX - tsX;
        let dy = e.changedTouches[0].clientY - tsY;
        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
            if(Math.abs(dx) > Math.abs(dy)) pacman.nextDir = dx > 0 ? 1 : -1;
            else pacman.nextDir = dy > 0 ? width : -width;
        }
    }, {passive: false});

    document.getElementById('start-btn').addEventListener('click', () => {
        startScreen.classList.add('hidden');
        // Play Music
        musicAudio.play().catch(e => console.log("Audio play failed interaction required"));
        init();
        gameActive = true;
        gameLoop();
    });

    window.addEventListener('resize', () => { if(gameActive) init(); });

    const style = document.createElement('style');
    style.textContent = `
        @keyframes quoteAppear { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes quoteDisappear { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -20px); } }
    `;
    document.head.appendChild(style);
</script>

</body>
</html>
