<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HEARTMAN: Hug Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #ff1493;
            --secondary: #00d4ff;
            --accent: #ff006e;
            --dark-bg: #0a0e27;
            --darker-bg: #050810;
            --neon-pink: #ff007f;
            --neon-cyan: #00ffff;
            --neon-purple: #b300ff;
        }
        
        body {
            background: var(--darker-bg);
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0033 50%, var(--darker-bg) 100%);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Fredoka One', sans-serif;
            color: #fff;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed; /* Lock body to prevent any scroll */
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: radial-gradient(ellipse at 50% 50%, rgba(255, 20, 147, 0.1) 0%, transparent 70%);
            padding: 10px;
            touch-action: none; /* Crucial for mobile swipe */
        }
        
        canvas {
            box-shadow: 
                0 0 30px rgba(255, 0, 127, 0.4),
                0 0 60px rgba(0, 212, 255, 0.2);
            border-radius: 8px;
            border: 2px solid var(--neon-pink);
            max-width: 100%;
            max-height: 70vh;
            background: #000;
            display: block;
        }
        
        .ui-layer {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            z-index: 10;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            background: rgba(10, 14, 39, 0.8);
            border-radius: 8px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 127, 0.3);
        }
        
        .score-label { color: var(--neon-pink); }
        #score-el { color: var(--neon-cyan); margin-left: 5px; }
        #high-score-el { color: var(--neon-purple); margin-left: 5px; }
        
        /* Screens */
        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
        }
        
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        #start-screen {
            background: rgba(5, 8, 16, 0.95);
        }
        
        .title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 900;
            color: var(--neon-pink);
            text-shadow: 0 0 20px var(--neon-pink);
            margin-bottom: 10px;
        }
        
        .title-sub {
            font-size: clamp(0.8rem, 3vw, 1.2rem);
            color: var(--neon-cyan);
            margin-bottom: 30px;
            letter-spacing: 2px;
        }
        
        #start-btn {
            padding: 15px 40px;
            background: transparent;
            border: 3px solid var(--neon-pink);
            color: var(--neon-pink);
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px var(--neon-pink);
        }
        
        #start-btn:hover {
            background: var(--neon-pink);
            color: #000;
            box-shadow: 0 0 30px var(--neon-pink);
            transform: scale(1.05);
        }
        
        /* Win Screen - Love Letter */
        #win-screen {
            background: radial-gradient(circle, #2d0015 0%, #050810 100%);
            overflow-y: auto;
            padding: 40px 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .love-letter {
            max-width: 600px;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--neon-pink);
            box-shadow: 0 0 40px rgba(255, 20, 147, 0.2);
            animation: letterFadeIn 2s ease-out;
        }
        
        @keyframes letterFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .love-letter h1 {
            font-family: 'Fredoka One', sans-serif;
            color: var(--neon-pink);
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .love-letter p {
            font-family: 'Fredoka One', sans-serif;
            line-height: 1.8;
            font-size: 18px;
            margin-bottom: 20px;
            color: #ffe4f1;
        }
        
        .heart-big {
            font-size: 60px;
            margin: 20px 0;
            animation: heartBeat 1.2s infinite;
            display: inline-block;
        }
        
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .reward-msg {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            color: var(--neon-cyan);
            margin-top: 30px;
            line-height: 1.5;
        }

        .mobile-hint {
            margin-top: 20px;
            font-size: 12px;
            color: #888;
            font-family: 'Press Start 2P', monospace;
        }

        @keyframes quoteAppear {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-layer">
        <div><span class="score-label">SCORE:</span><span id="score-el">0</span></div>
        <div><span class="score-label">BEST:</span><span id="high-score-el">0</span></div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div class="mobile-hint">SWIPE TO MOVE</div>
</div>

<!-- Start Screen -->
<div id="start-screen" class="screen">
    <div class="title-main">HEARTMAN</div>
    <div class="title-sub">HUG EDITION</div>
    <div id="enemies-display" style="margin-bottom: 30px; font-family: 'Press Start 2P'; font-size: 10px; color: var(--neon-cyan);">
        STRESS ‚Ä¢ ANXIETY ‚Ä¢ DOUBT ‚Ä¢ LONELINESS
    </div>
    <button id="start-btn">START MISSION</button>
    <div class="mobile-hint" style="margin-top: 40px;">COLLECT ALL HEARTS TO WIN</div>
</div>

<!-- Win Screen -->
<div id="win-screen" class="screen hidden">
    <div class="love-letter">
        <div class="heart-big">‚ù§Ô∏è</div>
        <h1>I Love You So Much</h1>
        <p>You bring so much value and meaning to my life. Every moment without you feels like a difficult level, but I know that love will always find a way through any situation, no matter how hard it gets.</p>
        <p>I miss your hug more than words can say. Your hug is my sanctuary‚Äîit heals the inner child in me and makes everything feel right again.</p>
        <p>You are my greatest achievement and my favorite person. Forever isn't long enough with you.</p>
        <div class="reward-msg">MISSION COMPLETE: TRUE LOVE FOUND</div>
        <button id="restart-btn" style="margin-top: 30px; padding: 10px 20px; background: none; border: 1px solid #fff; color: #fff; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px;">PLAY AGAIN</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-el');
    const highScoreEl = document.getElementById('high-score-el');
    const startScreen = document.getElementById('start-screen');
    const winScreen = document.getElementById('win-screen');
    
    const TILE_SIZE = 20;
    const width = 28;
    const layout = [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,3,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
        1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,4,4,4,4,4,4,4,4,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,2,2,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        4,4,4,4,4,4,0,0,0,4,1,2,2,2,2,2,2,1,4,0,0,0,4,4,4,4,4,4,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,4,4,4,4,4,4,4,4,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,3,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
    ];

    let squares = [];
    let score = 0;
    let highScore = 0;
    let gameActive = false;
    let audioCtx = null;
    let musicStarted = false;

    const pacman = {
        index: 490,
        dir: 0,
        nextDir: 0,
        rot: 0
    };

    const ghosts = [
        { name: 'blinky', index: 348, speed: 150, timer: 0, scared: false, start: 348, currentDir: -1, color: '#ff1744', displayName: 'STRESS' },
        { name: 'pinky', index: 376, speed: 200, timer: 0, scared: false, start: 376, currentDir: -1, color: '#ff6ec7', displayName: 'ANXIETY' },
        { name: 'inky', index: 351, speed: 250, timer: 0, scared: false, start: 351, currentDir: 1, color: '#9c27b0', displayName: 'DOUBT' },
        { name: 'clyde', index: 379, speed: 300, timer: 0, scared: false, start: 379, currentDir: 1, color: '#00bcd4', displayName: 'LONELINESS' }
    ];

    const hugQuotes = [
        "Your hug is my home.",
        "Everything is better with you.",
        "Love heals everything.",
        "You are my safe place.",
        "I miss your warmth."
    ];

    function init() {
        const availableHeight = window.innerHeight * 0.7;
        const availableWidth = window.innerWidth * 0.95;
        const size = Math.min(availableWidth, availableHeight);
        const scale = size / (width * TILE_SIZE);
        
        canvas.width = width * TILE_SIZE * scale;
        canvas.height = width * TILE_SIZE * scale;
        ctx.setTransform(scale, 0, 0, scale, 0, 0);
        
        // Calculate max score
        let totalDots = layout.filter(cell => cell === 0).length;
        let totalPower = layout.filter(cell => cell === 3).length;
        highScore = totalDots + (totalPower * 50);
        highScoreEl.innerText = highScore;
        
        drawBoard();
    }

    function drawBoard() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width * TILE_SIZE, width * TILE_SIZE);
        
        layout.forEach((cell, i) => {
            let x = (i % width) * TILE_SIZE;
            let y = Math.floor(i / width) * TILE_SIZE;
            
            if (cell === 1) {
                ctx.fillStyle = '#1a1a3e';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#ff007f';
                ctx.lineWidth = 0.5;
                ctx.strokeRect(x+2, y+2, TILE_SIZE-4, TILE_SIZE-4);
            } else if (cell === 0 && !squares[i]) {
                ctx.fillStyle = '#fbcfe8';
                ctx.beginPath();
                ctx.arc(x + 10, y + 10, 2, 0, Math.PI * 2);
                ctx.fill();
            } else if (cell === 3 && !squares[i]) {
                ctx.fillStyle = '#ff007f';
                ctx.beginPath();
                ctx.arc(x + 10, y + 10, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // Draw Pacman
        let px = (pacman.index % width) * TILE_SIZE + 10;
        let py = Math.floor(pacman.index / width) * TILE_SIZE + 10;
        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(pacman.rot);
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText('‚ù§Ô∏è', 0, 0);
        ctx.restore();

        // Draw Ghosts
        ghosts.forEach(g => {
            let gx = (g.index % width) * TILE_SIZE + 10;
            let gy = Math.floor(g.index / width) * TILE_SIZE + 10;
            ctx.fillStyle = g.scared ? '#38bdf8' : g.color;
            ctx.font = "14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(g.scared ? '‚òÅÔ∏è' : 'üëª', gx, gy);
        });
    }

    function gameLoop() {
        if (!gameActive) return;

        // Movement
        let nextMove = pacman.index + pacman.nextDir;
        if (layout[nextMove] !== 1 && layout[nextMove] !== 2) {
            pacman.dir = pacman.nextDir;
        }
        
        let moveIdx = pacman.index + pacman.dir;
        if (layout[moveIdx] !== 1 && layout[moveIdx] !== 2) {
            pacman.index = moveIdx;
            if (pacman.dir === 1) pacman.rot = 0;
            if (pacman.dir === -1) pacman.rot = Math.PI;
            if (pacman.dir === -width) pacman.rot = -Math.PI/2;
            if (pacman.dir === width) pacman.rot = Math.PI/2;
        }

        // Eating
        if ((layout[pacman.index] === 0 || layout[pacman.index] === 3) && !squares[pacman.index]) {
            let points = layout[pacman.index] === 3 ? 50 : 1;
            score += points;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
            
            if (layout[pacman.index] === 3) {
                showQuote();
                ghosts.forEach(g => g.scared = true);
                setTimeout(() => ghosts.forEach(g => g.scared = false), 8000);
                playSfx(880, 0.1);
            } else {
                playSfx(440, 0.05);
            }
        }

        if (score >= highScore) {
            endGame(true);
            return;
        }

        // Ghost AI
        ghosts.forEach(ghost => {
            ghost.timer++;
            let threshold = ghost.scared ? 15 : 8;
            if (ghost.timer > threshold) {
                ghost.timer = 0;
                const moves = [-1, 1, -width, width];
                let valid = moves.filter(d => layout[ghost.index + d] !== 1);
                ghost.index += valid[Math.floor(Math.random() * valid.length)];
                
                if (ghost.index === pacman.index) {
                    if (ghost.scared) {
                        ghost.index = ghost.start;
                        score += 100;
                    } else {
                        endGame(false);
                    }
                }
            }
        });

        drawBoard();
        setTimeout(() => requestAnimationFrame(gameLoop), 120);
    }

    function showQuote() {
        const q = hugQuotes[Math.floor(Math.random() * hugQuotes.length)];
        const div = document.createElement('div');
        div.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,20,147,0.9);padding:15px;border-radius:10px;color:white;z-index:1000;font-family:Fredoka One;animation:quoteAppear 0.5s ease-out;`;
        div.innerText = "üíñ " + q;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    }

    function playSfx(freq, dur) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(g);
        g.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + dur);
    }

    function startMusic() {
        if (musicStarted) return;
        musicStarted = true;
        const notes = [261, 329, 392, 523];
        let i = 0;
        setInterval(() => {
            if (gameActive) playSfx(notes[i++ % notes.length], 0.2);
        }, 500);
    }

    function endGame(win) {
        gameActive = false;
        if (win) {
            winScreen.classList.remove('hidden');
        } else {
            alert("Love is patient! Try again.");
            location.reload();
        }
    }

    // Controls
    document.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft') pacman.nextDir = -1;
        if (e.key === 'ArrowRight') pacman.nextDir = 1;
        if (e.key === 'ArrowUp') pacman.nextDir = -width;
        if (e.key === 'ArrowDown') pacman.nextDir = width;
    });

    let tsX, tsY;
    document.addEventListener('touchstart', e => {
        tsX = e.touches[0].clientX;
        tsY = e.touches[0].clientY;
    }, {passive: false});

    document.addEventListener('touchend', e => {
        let dx = e.changedTouches[0].clientX - tsX;
        let dy = e.changedTouches[0].clientY - tsY;
        if (Math.abs(dx) > 20 || Math.abs(dy) > 20) {
            if (Math.abs(dx) > Math.abs(dy)) pacman.nextDir = dx > 0 ? 1 : -1;
            else pacman.nextDir = dy > 0 ? width : -width;
        }
    }, {passive: false});

    document.getElementById('start-btn').addEventListener('click', () => {
        startScreen.classList.add('hidden');
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gameActive = true;
        startMusic();
        gameLoop();
    });

    document.getElementById('restart-btn').addEventListener('click', () => location.reload());

    window.onload = init;
    window.onresize = init;
    
    // Prevent scrolling during gameplay but allow it on win screen
    document.addEventListener('touchmove', e => {
        if (gameActive || !winScreen.classList.contains('hidden')) {
            if (gameActive) e.preventDefault();
        }
    }, {passive: false});
</script>

</body>
</html>
