<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEARTMAN: Hug Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Press+Start+2P&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #ff1493;
            --secondary: #00d4ff;
            --accent: #ff006e;
            --dark-bg: #0a0e27;
            --darker-bg: #050810;
            --neon-pink: #ff007f;
            --neon-cyan: #00ffff;
            --neon-purple: #b300ff;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0033 50%, var(--darker-bg) 100%);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Fredoka One', sans-serif;
            color: #fff;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: radial-gradient(ellipse at 50% 50%, rgba(255, 20, 147, 0.1) 0%, transparent 70%);
        }
        
        canvas {
            box-shadow: 
                0 0 30px rgba(255, 0, 127, 0.4),
                0 0 60px rgba(0, 212, 255, 0.2),
                inset 0 0 30px rgba(255, 0, 127, 0.1);
            border-radius: 8px;
            border: 2px solid var(--neon-pink);
            max-width: 100%;
            max-height: 75vh; /* Reduced slightly to fit controls */
            background: #000;
            display: block;
        }
        
        /* UI Top Layer */
        .ui-layer {
            width: 100%;
            max-width: 560px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 24px;
            box-sizing: border-box;
            z-index: 10;
            font-family: 'Press Start 2P', monospace;
            font-size: 11px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-cyan);
            background: rgba(10, 14, 39, 0.6);
            border-radius: 8px;
            margin-bottom: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 0, 127, 0.3);
        }
        
        .score-label { color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); }
        #score-el { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); font-weight: bold; min-width: 60px; text-align: right; }
        .goal-label { color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple); }
        #target-el { color: #fff; }

        /* Bottom Controls */
        .bottom-controls {
            width: 100%;
            max-width: 560px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-family: 'Fredoka One', sans-serif;
            font-size: 12px;
            color: #ccc;
            backdrop-filter: blur(5px);
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }

        .control-icon { font-size: 20px; }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        /* Screens (Start, Game Over, Finale) */
        .overlay-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(8px);
        }
        
        #start-screen {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.95) 0%, rgba(26, 0, 51, 0.95) 100%);
            border: 1px solid rgba(255, 0, 127, 0.2);
        }

        #game-over-screen {
            background: radial-gradient(circle at center, rgba(50, 0, 0, 0.9) 0%, #000 100%);
            z-index: 55;
        }

        #finale-screen {
            background: radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.95) 100%);
            z-index: 60;
        }
        
        .title-container {
            text-align: center;
            margin-bottom: 20px;
            animation: titleGlow 2s ease-in-out infinite;
        }
        
        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px var(--neon-pink), 0 0 20px var(--neon-pink); }
            50% { text-shadow: 0 0 20px var(--neon-pink), 0 0 40px var(--neon-cyan), 0 0 60px var(--neon-pink); }
        }
        
        .title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 900;
            color: var(--neon-pink);
            letter-spacing: 4px;
            line-height: 1.1;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .title-sub {
            font-family: 'Fredoka One', sans-serif;
            font-size: clamp(0.8rem, 3vw, 1.2rem);
            color: var(--neon-cyan);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 32px;
        }
        
        /* Buttons */
        .retro-btn {
            position: relative;
            padding: 16px 32px;
            background: transparent;
            border: 3px solid var(--neon-pink);
            color: var(--neon-pink);
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.3);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .retro-btn:hover {
            background: rgba(255, 0, 127, 0.2);
            color: #fff;
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.6), 0 0 60px rgba(0, 212, 255, 0.3);
            transform: scale(1.05);
        }

        /* Animations */
        .heart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .heart-emoji {
            font-size: clamp(4rem, 15vw, 8rem);
            position: absolute;
            transition: all 1s ease;
            filter: drop-shadow(0 0 20px rgba(255, 0, 127, 0.5));
        }
        
        #final-heart { left: 15%; animation: heartFloat 3s ease-in-out infinite; }
        #final-partner { right: 15%; opacity: 0.4; animation: partnerFloat 3s ease-in-out infinite; animation-delay: 0.5s; }
        #final-hug { opacity: 0; transform: scale(0.5); animation: hugAppear 1s ease-out forwards 1.5s, hugPulse 1s ease-in-out infinite 2.5s; }
        
        @keyframes heartFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        @keyframes partnerFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        @keyframes hugAppear { to { opacity: 1; transform: scale(1); } }
        @keyframes hugPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .finale-text, .game-over-text {
            text-align: center;
            opacity: 0;
            animation: fadeInText 1s ease-out forwards 0.5s;
        }
        
        @keyframes fadeInText { to { opacity: 1; } }
        
        .finale-quote {
            font-family: 'Fredoka One', sans-serif;
            font-size: clamp(1rem, 4vw, 1.4rem);
            color: var(--neon-cyan);
            text-shadow: 0 0 20px var(--neon-cyan);
            line-height: 1.6;
            margin-bottom: 24px;
            font-style: italic;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .finale-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(0.8rem, 3vw, 1.2rem);
            color: var(--neon-pink);
            text-shadow: 0 0 20px var(--neon-pink);
            letter-spacing: 2px;
            margin-bottom: 24px;
            text-transform: uppercase;
        }

        .game-over-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 2rem;
            color: #ff3333;
            text-shadow: 0 0 20px #ff0000;
            margin-bottom: 20px;
        }

        .game-over-sub {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #ddd;
        }

        /* Popup Notification */
        #quote-popup {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translate(-50%, -20px);
            background: rgba(255, 0, 127, 0.95);
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            font-family: 'Fredoka One', sans-serif;
            font-size: 14px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.6);
            border: 2px solid #ff007f;
            max-width: 90%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        #quote-popup.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        
        @media (max-width: 600px) {
            .ui-layer { font-size: 9px; padding: 10px 16px; gap: 12px; }
            canvas { border-radius: 6px; border-width: 1px; }
            .bottom-controls { flex-wrap: wrap; font-size: 10px; }
            .control-item { width: 45%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-layer">
        <div>
            <span class="score-label">SCORE:</span>
            <span id="score-el">0</span>
        </div>
        <div>
            <span class="goal-label">TARGET: <span id="target-el">0</span></span>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div class="bottom-controls">
        <div class="control-item">
            <div class="control-icon">üëÜüëáüëàüëâ</div>
            <div>Swipe / Arrow Keys</div>
        </div>
        <div class="control-item">
            <div class="control-icon">‚ù§Ô∏è</div>
            <div>Collect All Love</div>
        </div>
        <div class="control-item">
            <div class="control-icon">üò°üò∞üòµ‚Äçüí´ü•∫</div>
            <div>Avoid Glooms</div>
        </div>
         <div class="control-item">
            <div class="control-icon">üíó</div>
            <div>Powerup (x4 Only)</div>
        </div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <div class="title-container">
            <div class="title-main">HEART<br>MAN</div>
            <div class="title-sub">‚ù§Ô∏è HUG DAY SPECIAL ‚ù§Ô∏è</div>
        </div>
        
        <div id="enemies-display" style="margin: 20px 0; text-align: center; font-family: 'Press Start 2P', monospace; font-size: 9px; color: #00d4ff; text-shadow: 0 0 10px #00d4ff;"></div>
        
        <button id="start-btn" class="retro-btn">INSERT COIN</button>
    </div>

    <div id="game-over-screen" class="overlay-screen hidden">
        <div class="game-over-text">
            <h1 class="game-over-title">HEARTBROKEN</h1>
            <p class="game-over-sub">The Glooms got you...<br>But love never gives up.</p>
            <button class="retro-btn" onclick="location.reload()">TRY AGAIN</button>
        </div>
    </div>

    <div id="finale-screen" class="overlay-screen hidden">
        <div class="heart-container">
            <div id="final-heart" class="heart-emoji">‚ù§Ô∏è</div>
            <div id="final-partner" class="heart-emoji">üë§</div>
            <div id="final-hug" class="heart-emoji">ü´Ç</div>
        </div>
        
        <div class="finale-text">
            <p class="finale-quote">
                "No matter how bad the situations are, love always finds a way.<br>I love your hugs. You're the best."
            </p>
            <h2 class="finale-title">HAPPY HUG DAY!</h2>
            <button class="retro-btn" onclick="location.reload()">REPLAY FOREVER</button>
        </div>
    </div>

    <div id="quote-popup"></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-el');
    const targetEl = document.getElementById('target-el');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finaleScreen = document.getElementById('finale-screen');
    const quotePopup = document.getElementById('quote-popup');

    // --- CONFIGURATION ---
    const width = 28;
    const TILE_SIZE = 20;
    
    // 0 = Dot (1pt), 1 = Wall, 2 = Ghost House, 3 = Powerup (50pts), 4 = Empty
    const layout = [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,3,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,4,4,4,4,4,4,4,4,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,2,2,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        4,4,4,4,4,4,0,0,0,4,1,2,2,2,2,2,2,1,4,0,0,0,4,4,4,4,4,4,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,3,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
    ];

    let squares = [];
    let score = 0;
    let winningScore = 0;
    let gameActive = false;
    let musicAudio = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Tours/Enthusiast/Tours_-_01_-_Enthusiast.mp3');
    musicAudio.loop = true;
    musicAudio.volume = 0.4;
    
    let pacman = { index: 490, dir: 1, nextDir: 1, rot: 0 };
    let currentSessionQuotes = [];

    // --- CALCULATE EXACT WINNING SCORE ---
    function countMaxScore() {
        let total = 0;
        layout.forEach(cell => {
            if(cell === 0) total += 1;
            if(cell === 3) total += 50;
        });
        return total;
    }

    // --- ROMANTIC QUOTE POOL (20+) ---
    const allQuotes = [
        "Imagine me grabbing your bum while we kiss",
        "Imagine us kissing in the rain on the rooftop of our house",
        "Imagine us cuddling together in a thunderstorm under a blanket",
        "I want to wake up next to you every single day",
        "Your laugh is my favorite sound in the world",
        "You are my safe space",
        "Every love song is about you now",
        "I‚Äôd choose you in a hundred lifetimes",
        "Imagine us cooking dinner together dancing to jazz",
        "You make the gloomy days sunny",
        "I am so addicted to you",
        "Imagine us holding hands walking down an old street",
        "My heart beats faster whenever you are near",
        "You are the best thing that ever happened to me",
        "I love you more than pizza (and that says a lot)",
        "Imagine a lazy Sunday morning just tangled in sheets",
        "You are my home",
        "I just want to hold you tight and never let go",
        "Even when I'm angry, I still love you",
        "Imagine us growing old and still flirting",
        "You're the peanut butter to my jelly",
        "I love it when you smile at me",
        "Imagine late night drives with your hand in mine"
    ];

    function shuffleQuotes() {
        let shuffled = [...allQuotes].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 4);
    }
    
    // Ghost Data
    let ghosts = [
        { name: 'blinky', index: 348, speed: 130, timer: 0, scared: false, start: 348, currentDir: -1, color: '#ff1744', displayName: 'STRESS', icon: 'üò°' },
        { name: 'pinky', index: 376, speed: 180, timer: 0, scared: false, start: 376, currentDir: -1, color: '#ff6ec7', displayName: 'ANXIETY', icon: 'üò∞' },
        { name: 'inky', index: 351, speed: 220, timer: 0, scared: false, start: 351, currentDir: 1, color: '#9c27b0', displayName: 'DOUBT', icon: 'üòµ‚Äçüí´' },
        { name: 'clyde', index: 379, speed: 280, timer: 0, scared: false, start: 379, currentDir: 1, color: '#00bcd4', displayName: 'LONELINESS', icon: 'ü•∫' }
    ];
    
    function displayEnemiesOnTitle() {
        const enemiesDisplay = document.getElementById('enemies-display');
        if (!enemiesDisplay) return;
        let html = '<div style="margin-bottom: 12px; letter-spacing: 2px; color: #ff007f;">THE GLOOMS:</div>';
        ghosts.forEach(g => {
            html += `<div style="margin: 5px 0; color: ${g.color}; text-shadow: 0 0 8px ${g.color}; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 14px;">${g.icon}</span> <span>${g.displayName}</span>
                     </div>`;
        });
        enemiesDisplay.innerHTML = html;
    }

    displayEnemiesOnTitle();
    
    function init() {
        // Layout Scaling
        const availableHeight = window.innerHeight * 0.7; // Reduced height to fit controls
        const availableWidth = window.innerWidth * 0.95;
        let scale = Math.min(availableWidth / (width * TILE_SIZE), availableHeight / (width * TILE_SIZE));
        canvas.width = width * TILE_SIZE * scale;
        canvas.height = width * TILE_SIZE * scale;
        ctx.scale(scale, scale);
        
        // Setup Game Logic
        winningScore = countMaxScore();
        targetEl.innerText = winningScore;
        currentSessionQuotes = shuffleQuotes();
        
        drawBoard();
    }

    function getCoordinates(index) {
        return { x: index % width, y: Math.floor(index / width) };
    }

    function getDistance(idx1, idx2) {
        const c1 = getCoordinates(idx1);
        const c2 = getCoordinates(idx2);
        return Math.sqrt(Math.pow(c1.x - c2.x, 2) + Math.pow(c1.y - c2.y, 2));
    }

    function gameLoop() {
        if (!gameActive) return;

        // --- PACMAN MOVEMENT ---
        let nextMove = pacman.index + pacman.nextDir;
        if(layout[nextMove] !== 1 && layout[nextMove] !== 2) {
            pacman.dir = pacman.nextDir;
        }
        let moveIdx = pacman.index + pacman.dir;
        
        if (layout[moveIdx] !== 1 && layout[moveIdx] !== 2) {
            pacman.index = moveIdx;
        }

        if(pacman.index === 392) pacman.index = 419;
        else if(pacman.index === 419) pacman.index = 392;

        if (layout[pacman.index] === 0 && !squares[pacman.index]) {
            score++;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
        } else if (layout[pacman.index] === 3 && !squares[pacman.index]) {
            score += 50;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
            
            // Pop a quote
            if(currentSessionQuotes.length > 0) {
                showHugQuote(currentSessionQuotes.pop());
            } else {
                showHugQuote("I love you more!");
            }
            
            ghosts.forEach(g => g.scared = true);
            setTimeout(() => ghosts.forEach(g => g.scared = false), 10000);
            if(navigator.vibrate) navigator.vibrate(20);
        }

        // Exact Score Win Condition
        if (score >= winningScore) { endGame(true); return; }

        // --- GHOST AI ---
        ghosts.forEach(ghost => {
            ghost.timer++;
            let moveThreshold = ghost.scared ? 12 : (ghost.name === 'blinky' ? 4 : 6); 
            
            if (ghost.timer > moveThreshold) {
                ghost.timer = 0;
                
                const possibleMoves = [-1, 1, -width, width];
                let validMoves = possibleMoves.filter(dir => {
                    let next = ghost.index + dir;
                    if(layout[next] === 1) return false;
                    if (!ghost.scared && dir === -ghost.currentDir) return false;
                    return true;
                });

                if(validMoves.length === 0) {
                     validMoves = possibleMoves.filter(dir => {
                        let next = ghost.index + dir;
                        return layout[next] !== 1;
                     });
                }

                if (validMoves.length > 0) {
                    let bestDir = validMoves[Math.floor(Math.random() * validMoves.length)];
                    
                    if (!ghost.scared) {
                        // HUNTING LOGIC
                        let target = pacman.index;
                        if (ghost.name === 'pinky') target = pacman.index + (pacman.dir * 4);
                        if (ghost.name === 'clyde') {
                            if(getDistance(ghost.index, pacman.index) < 8) target = 0;
                        }

                        let minDst = Infinity;
                        validMoves.forEach(dir => {
                            let dst = getDistance(ghost.index + dir, target);
                            if (dst < minDst) { minDst = dst; bestDir = dir; }
                        });
                    } else {
                        // FEAR LOGIC
                        let maxDst = -1;
                        validMoves.forEach(dir => {
                            let dst = getDistance(ghost.index + dir, pacman.index);
                            if (dst > maxDst) { maxDst = dst; bestDir = dir; }
                        });
                    }
                    
                    ghost.currentDir = bestDir;
                    ghost.index += bestDir;
                }

                if (ghost.index === pacman.index) {
                    if (ghost.scared) ghost.index = ghost.start;
                    else endGame(false);
                }
            }
        });

        drawBoard();
        setTimeout(() => requestAnimationFrame(gameLoop), 50); 
    }

    function drawBoard() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width*TILE_SIZE, width*TILE_SIZE);
        
        layout.forEach((cell, i) => {
            let x = (i % width) * TILE_SIZE;
            let y = Math.floor(i / width) * TILE_SIZE;
            
            if (cell === 1) { 
                ctx.fillStyle = '#1a1a3e';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#334155';
                ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE);
                ctx.strokeStyle = '#ff007f';
                ctx.lineWidth = 1;
                ctx.strokeRect(x+5,y+5,TILE_SIZE-10,TILE_SIZE-10);
            } else if (cell === 0 && !squares[i]) { 
                ctx.fillStyle = '#fbcfe8';
                ctx.beginPath();
                ctx.arc(x+10, y+10, 2, 0, Math.PI*2);
                ctx.fill();
            } else if (cell === 3 && !squares[i]) { 
                ctx.fillStyle = '#ff007f';
                ctx.shadowColor = '#ff007f';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(x+10, y+10, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        });

        // DRAW HEARTMAN
        let px = (pacman.index % width) * TILE_SIZE + 10;
        let py = Math.floor(pacman.index / width) * TILE_SIZE + 10;
        ctx.save();
        ctx.translate(px, py);
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ff3366';
        ctx.font = "20px 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText('‚ù§Ô∏è', 0, 2);
        ctx.restore();

        // DRAW GLOOMS
        ghosts.forEach(g => {
            let gx = (g.index % width) * TILE_SIZE + 10;
            let gy = Math.floor(g.index / width) * TILE_SIZE + 10;
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = g.color;
            ctx.font = "20px 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            let emoji = g.scared ? 'ü´•' : g.icon;
            ctx.fillText(emoji, gx, gy + 2);
            ctx.shadowBlur = 0;
        });
    }

    function showHugQuote(text) {
        quotePopup.innerHTML = '‚ú® ' + text + ' ‚ú®';
        quotePopup.classList.add('visible');
        setTimeout(() => {
            quotePopup.classList.remove('visible');
        }, 3000);
    }

    function endGame(win) {
        gameActive = false;
        if(win) {
            finaleScreen.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('final-heart').style.opacity = '1';
                document.getElementById('final-partner').style.opacity = '0.4';
                document.getElementById('final-hug').style.opacity = '1';
                if(navigator.vibrate) navigator.vibrate([100,50,100]);
            }, 500);
        } else {
            gameOverScreen.classList.remove('hidden');
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }

    document.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft' || e.key === 'a') pacman.nextDir = -1;
        if(e.key === 'ArrowRight' || e.key === 'd') pacman.nextDir = 1;
        if(e.key === 'ArrowUp' || e.key === 'w') pacman.nextDir = -width;
        if(e.key === 'ArrowDown' || e.key === 's') pacman.nextDir = width;
    });

    let tsX, tsY;
    document.addEventListener('touchstart', e => { tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; }, {passive: false});
    document.addEventListener('touchend', e => {
        let dx = e.changedTouches[0].clientX - tsX;
        let dy = e.changedTouches[0].clientY - tsY;
        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
            if(Math.abs(dx) > Math.abs(dy)) pacman.nextDir = dx > 0 ? 1 : -1;
            else pacman.nextDir = dy > 0 ? width : -width;
        }
    }, {passive: false});

    document.getElementById('start-btn').addEventListener('click', () => {
        startScreen.classList.add('hidden');
        musicAudio.play().catch(e => console.log("Audio play failed interaction required"));
        init();
        gameActive = true;
        gameLoop();
    });

    window.addEventListener('resize', () => { if(gameActive) init(); });
</script>

</body>
</html>
