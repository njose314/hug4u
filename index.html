<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEARTMAN: Hug Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #ff1493;
            --secondary: #00d4ff;
            --accent: #ff006e;
            --dark-bg: #0a0e27;
            --darker-bg: #050810;
            --neon-pink: #ff007f;
            --neon-cyan: #00ffff;
            --neon-purple: #b300ff;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0033 50%, var(--darker-bg) 100%);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            font-family: 'Press Start 2P', cursive; /* Global Pixel Font */
            color: #fff;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: radial-gradient(ellipse at 50% 50%, rgba(255, 20, 147, 0.1) 0%, transparent 70%);
        }
        
        canvas {
            box-shadow: 
                0 0 30px rgba(255, 0, 127, 0.4),
                0 0 60px rgba(0, 212, 255, 0.2),
                inset 0 0 30px rgba(255, 0, 127, 0.1);
            border-radius: 4px;
            border: 4px solid var(--neon-pink);
            max-width: 100%;
            max-height: 70vh; 
            background: #000;
            display: block;
            image-rendering: pixelated;
        }
        
        /* UI Top Layer */
        .ui-layer {
            width: 100%;
            max-width: 560px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 10px;
            box-sizing: border-box;
            z-index: 10;
            font-size: 10px; /* Reduced for pixel font */
            letter-spacing: 1px;
            text-shadow: 0 0 10px var(--neon-pink);
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .score-label { color: var(--neon-pink); }
        #score-el { color: var(--neon-cyan); }
        .goal-label { color: var(--neon-purple); }
        #target-el { color: #fff; }

        /* Bottom Controls */
        .bottom-controls {
            width: 100%;
            max-width: 560px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 8px; /* Tiny pixel text */
            color: #aaa;
            text-transform: uppercase;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-align: center;
        }

        .control-icon { font-size: 16px; margin-bottom: 2px; }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }

        /* Screens */
        .overlay-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
            padding: 20px;
        }
        
        #start-screen {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.98) 0%, rgba(26, 0, 51, 0.98) 100%);
        }

        #game-over-screen {
            background: rgba(20, 0, 0, 0.95);
            z-index: 55;
        }

        #finale-screen {
            background: #000;
            z-index: 60;
            border: 4px solid var(--neon-pink);
        }
        
        /* Titles */
        .title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 900;
            color: var(--neon-pink);
            letter-spacing: 4px;
            margin-bottom: 16px;
            text-align: center;
            text-shadow: 4px 4px 0px #96004b;
        }
        
        .title-sub {
            font-size: clamp(0.5rem, 2.5vw, 0.8rem);
            color: var(--neon-cyan);
            letter-spacing: 1px;
            margin-bottom: 32px;
            text-align: center;
            line-height: 1.5;
        }
        
        /* Pixel Button */
        .retro-btn {
            padding: 15px 20px;
            background: #000;
            border: 4px solid var(--neon-pink);
            color: var(--neon-pink);
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.1s;
            text-transform: uppercase;
            box-shadow: 6px 6px 0px rgba(255, 0, 127, 0.4);
            margin-top: 20px;
        }
        
        .retro-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 2px 2px 0px rgba(255, 0, 127, 0.4);
        }

        /* --- PIXEL ART HEART (CSS ONLY) --- */
        .pixel-heart {
            position: relative;
            width: 20px;
            height: 20px;
            background: var(--neon-pink);
            box-shadow: 
                20px 0 var(--neon-pink), 
                40px 0 var(--neon-pink), 
                0 20px var(--neon-pink), 
                60px 20px var(--neon-pink), 
                0 40px var(--neon-pink), 
                60px 40px var(--neon-pink), 
                20px 60px var(--neon-pink), 
                40px 60px var(--neon-pink), 
                20px 80px var(--neon-pink), 
                40px 80px var(--neon-pink),
                30px 100px var(--neon-pink); /* Tip */
            transform: scale(3);
            margin: 60px auto; 
            image-rendering: pixelated;
            animation: pixelBeat 1.5s infinite steps(2);
        }
        
        /* Helper to make the shape correct with box-shadows on a 1x1 div */
        .pixel-heart-container {
            width: 100px;
            height: 100px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        /* Simplified 8-bit Heart Shape using a pseudo element technique for cleaner code */
        .pixel-heart-art {
            width: 10px; 
            height: 10px; 
            background: transparent;
            color: var(--neon-pink);
            box-shadow: 
                20px 0, 50px 0,
                10px 10px, 60px 10px,
                0 20px, 70px 20px,
                0 30px, 70px 30px,
                0 40px, 70px 40px,
                10px 50px, 60px 50px,
                20px 60px, 50px 60px,
                30px 70px, 40px 70px;
            transform: scale(3);
            animation: pixelBeat 0.8s infinite alternate;
        }

        @keyframes pixelBeat {
            from { transform: scale(3); }
            to { transform: scale(3.5); filter: brightness(1.3); }
        }
        
        /* Typography */
        .finale-text {
            text-align: center;
            max-width: 600px;
        }
        
        .finale-quote {
            font-size: clamp(0.7rem, 2vw, 1rem); /* Pixel font needs space */
            color: var(--neon-cyan);
            line-height: 1.8;
            margin-bottom: 30px;
            text-shadow: 2px 2px 0 #0055aa;
            border: 2px dashed #333;
            padding: 20px;
            background: rgba(0,0,0,0.5);
        }
        
        .finale-title {
            font-size: 1.5rem;
            color: var(--neon-pink);
            margin-bottom: 24px;
            text-transform: uppercase;
            text-shadow: 3px 3px 0 #550022;
            animation: rainbow 3s infinite;
        }

        @keyframes rainbow {
            0% { color: #ff007f; }
            33% { color: #00ffff; }
            66% { color: #ff00ff; }
            100% { color: #ff007f; }
        }

        .game-over-title {
            font-size: 2rem;
            color: #ff3333;
            text-shadow: 4px 4px 0 #550000;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-over-sub {
            font-size: 0.8rem;
            margin-bottom: 30px;
            color: #ccc;
            text-align: center;
            line-height: 1.6;
        }

        /* Popup Notification */
        #quote-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translate(-50%, -20px);
            background: #000;
            color: var(--neon-pink);
            padding: 15px 15px;
            border: 2px solid var(--neon-pink);
            box-shadow: 4px 4px 0 rgba(255, 0, 127, 0.5);
            font-size: 9px; 
            text-align: center;
            z-index: 100;
            max-width: 95%;
            width: 300px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            line-height: 1.4;
        }

        #quote-popup.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        
        @media (max-width: 600px) {
            .ui-layer { padding: 10px; }
            .bottom-controls { flex-wrap: wrap; }
            .control-item { width: 45%; margin-bottom: 5px; }
            .title-main { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-layer">
        <div>
            <span class="score-label">PTS:</span>
            <span id="score-el">0</span>
        </div>
        <div>
            <span class="goal-label">GOAL: <span id="target-el">0</span></span>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div class="bottom-controls">
        <div class="control-item">
            <div class="control-icon">üïπÔ∏è</div>
            <div>Swipe</div>
        </div>
        <div class="control-item">
            <div class="control-icon">‚ù§Ô∏è</div>
            <div>Collect</div>
        </div>
        <div class="control-item">
            <div class="control-icon">üëæ</div>
            <div>Avoid</div>
        </div>
         <div class="control-item">
            <div class="control-icon">‚ö°</div>
            <div>Powerup</div>
        </div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <div class="title-main">HEART<br>MAN</div>
        <div class="title-sub">HUG DAY EDITION<br>v2.0</div>
        
        <div id="enemies-display" style="margin: 20px 0; text-align: center; font-size: 8px; color: #00d4ff; line-height: 1.8;"></div>
        
        <button id="start-btn" class="retro-btn">INSERT COIN</button>
    </div>

    <div id="game-over-screen" class="overlay-screen hidden">
        <h1 class="game-over-title">GAME OVER</h1>
        <p class="game-over-sub">The Glooms win this time.<br>But love is persistent.</p>
        <button class="retro-btn" onclick="location.reload()">RETRY</button>
    </div>

    <div id="finale-screen" class="overlay-screen hidden">
        <div class="pixel-heart-container">
            <div class="pixel-heart-art"></div>
        </div>
        
        <div class="finale-text">
            <h2 class="finale-title">HAPPY HUG DAY</h2>
            <div id="final-quote-container" class="finale-quote"></div>
            <button class="retro-btn" onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>

    <div id="quote-popup"></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-el');
    const targetEl = document.getElementById('target-el');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finaleScreen = document.getElementById('finale-screen');
    const quotePopup = document.getElementById('quote-popup');
    const finalQuoteContainer = document.getElementById('final-quote-container');

    // --- CONFIGURATION ---
    const width = 28;
    const TILE_SIZE = 20;
    
    // 0 = Dot, 1 = Wall, 2 = House, 3 = Powerup, 4 = Empty
    const layout = [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,3,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,4,4,4,4,4,4,4,4,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,2,2,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        4,4,4,4,4,4,0,0,0,4,1,2,2,2,2,2,2,1,4,0,0,0,4,4,4,4,4,4,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,3,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
    ];

    let squares = [];
    let score = 0;
    let winningScore = 0;
    let gameActive = false;
    let musicAudio = new Audio('https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Tours/Enthusiast/Tours_-_01_-_Enthusiast.mp3');
    musicAudio.loop = true;
    musicAudio.volume = 0.4;
    
    let pacman = { index: 490, dir: 1, nextDir: 1, rot: 0 };
    let currentSessionQuotes = [];

    // --- 40 POWERUP QUOTES ---
    const powerupQuotes = [
        "Imagine me grabbing your bum while we kiss",
        "Imagine us kissing in the rain on the roof",
        "Imagine us cuddling in a thunderstorm",
        "I want to wake up next to you daily",
        "Your laugh is my favorite sound",
        "You are my safe space",
        "Every love song is about you",
        "I'd choose you in a hundred lifetimes",
        "Imagine us dancing to jazz in the kitchen",
        "You make the gloomy days sunny",
        "I am so addicted to you",
        "Imagine holding hands on an old street",
        "My heart beats faster near you",
        "You are the best thing ever",
        "I love you more than pizza",
        "Imagine a lazy Sunday in sheets",
        "You are my home",
        "I just want to hold you tight",
        "Even when I'm angry, I love you",
        "Imagine us growing old flirting",
        "You're the peanut butter to my jelly",
        "I love it when you smile at me",
        "Imagine late night drives holding hands",
        "You smell like home",
        "I crave your touch constantly",
        "You are my favorite distraction",
        "I love you to the moon and back",
        "You are my happy place",
        "Imagine us star gazing on a hill",
        "I love the way you look at me",
        "You're my dream come true",
        "Imagine breakfast in bed together",
        "I want to steal your hoodies",
        "You're sweeter than chocolate",
        "I get butterflies seeing you",
        "Imagine us adopting a puppy",
        "I never want to stop making memories",
        "Your voice calms my soul",
        "I love your warm hugs",
        "You are my forever plus one"
    ];

    // --- 20 FINALE QUOTES ---
    const finaleQuotes = [
        "No matter how bad the situations are, love always finds a way. I love your hugs.",
        "In your arms is the only place I want to be. Happy Hug Day.",
        "A hug from you mends all my broken pieces. You are my everything.",
        "Distance means nothing when one hug can change everything.",
        "I would fight the world just to end the day in your arms.",
        "Your hugs are my anchor in this stormy world.",
        "One hug from you wipes away a thousand worries.",
        "Home is not a place, it's the feeling of your arms around me.",
        "I survived the maze of life just to find your embrace.",
        "The best gift you can give me is a tight hug that lasts forever.",
        "My favorite place in the universe? Right next to you.",
        "Through every gloom and every fear, I choose you.",
        "You are the pause button on my chaotic life.",
        "Let's stay tangled in a hug until the world ends.",
        "Your heartbeat is the rhythm I want to fall asleep to.",
        "Nothing feels as safe as being held by you.",
        "I gathered all this love just to give it to you.",
        "A hug is a handshake from the heart, and my heart is yours.",
        "You are the warmth in my coldest winters.",
        "Here's to a lifetime of hugs, laughter, and us."
    ];

    function countMaxScore() {
        let total = 0;
        layout.forEach(cell => {
            if(cell === 0) total += 1;
            if(cell === 3) total += 50;
        });
        return total;
    }

    function shuffleQuotes(pool, count) {
        let shuffled = [...pool].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    }
    
    // Ghost Data
    let ghosts = [
        { name: 'blinky', index: 348, speed: 130, timer: 0, scared: false, start: 348, currentDir: -1, color: '#ff1744', displayName: 'STRESS', icon: 'üò°' },
        { name: 'pinky', index: 376, speed: 180, timer: 0, scared: false, start: 376, currentDir: -1, color: '#ff6ec7', displayName: 'ANXIETY', icon: 'üò∞' },
        { name: 'inky', index: 351, speed: 220, timer: 0, scared: false, start: 351, currentDir: 1, color: '#9c27b0', displayName: 'DOUBT', icon: 'üòµ‚Äçüí´' },
        { name: 'clyde', index: 379, speed: 280, timer: 0, scared: false, start: 379, currentDir: 1, color: '#00bcd4', displayName: 'LONELINESS', icon: 'ü•∫' }
    ];
    
    function displayEnemiesOnTitle() {
        const enemiesDisplay = document.getElementById('enemies-display');
        if (!enemiesDisplay) return;
        let html = '<div style="margin-bottom: 8px; color: #ff007f;">THE GLOOMS:</div>';
        ghosts.forEach(g => {
            html += `<div style="margin: 4px 0; color: ${g.color}; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 14px;">${g.icon}</span> <span>${g.displayName}</span>
                     </div>`;
        });
        enemiesDisplay.innerHTML = html;
    }

    displayEnemiesOnTitle();
    
    function init() {
        const availableHeight = window.innerHeight * 0.7; 
        const availableWidth = window.innerWidth * 0.95;
        let scale = Math.min(availableWidth / (width * TILE_SIZE), availableHeight / (width * TILE_SIZE));
        canvas.width = width * TILE_SIZE * scale;
        canvas.height = width * TILE_SIZE * scale;
        ctx.scale(scale, scale);
        
        // Setup Game Logic
        winningScore = countMaxScore();
        targetEl.innerText = winningScore;
        currentSessionQuotes = shuffleQuotes(powerupQuotes, 4); // Pick 4 random quotes for this run
        
        drawBoard();
    }

    function getCoordinates(index) {
        return { x: index % width, y: Math.floor(index / width) };
    }

    function getDistance(idx1, idx2) {
        const c1 = getCoordinates(idx1);
        const c2 = getCoordinates(idx2);
        return Math.sqrt(Math.pow(c1.x - c2.x, 2) + Math.pow(c1.y - c2.y, 2));
    }

    function gameLoop() {
        if (!gameActive) return;

        // --- PACMAN MOVEMENT ---
        let nextMove = pacman.index + pacman.nextDir;
        if(layout[nextMove] !== 1 && layout[nextMove] !== 2) {
            pacman.dir = pacman.nextDir;
        }
        let moveIdx = pacman.index + pacman.dir;
        
        if (layout[moveIdx] !== 1 && layout[moveIdx] !== 2) {
            pacman.index = moveIdx;
        }

        if(pacman.index === 392) pacman.index = 419;
        else if(pacman.index === 419) pacman.index = 392;

        if (layout[pacman.index] === 0 && !squares[pacman.index]) {
            score++;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
        } else if (layout[pacman.index] === 3 && !squares[pacman.index]) {
            score += 50;
            squares[pacman.index] = true;
            scoreEl.innerText = score;
            
            // Pop a quote
            if(currentSessionQuotes.length > 0) {
                showHugQuote(currentSessionQuotes.pop());
            } else {
                showHugQuote("Bonus Love!");
            }
            
            ghosts.forEach(g => g.scared = true);
            setTimeout(() => ghosts.forEach(g => g.scared = false), 10000);
            if(navigator.vibrate) navigator.vibrate(20);
        }

        if (score >= winningScore) { endGame(true); return; }

        // --- GHOST AI ---
        ghosts.forEach(ghost => {
            ghost.timer++;
            let moveThreshold = ghost.scared ? 12 : (ghost.name === 'blinky' ? 4 : 6); 
            
            if (ghost.timer > moveThreshold) {
                ghost.timer = 0;
                
                const possibleMoves = [-1, 1, -width, width];
                let validMoves = possibleMoves.filter(dir => {
                    let next = ghost.index + dir;
                    if(layout[next] === 1) return false;
                    if (!ghost.scared && dir === -ghost.currentDir) return false;
                    return true;
                });

                if(validMoves.length === 0) {
                     validMoves = possibleMoves.filter(dir => {
                        let next = ghost.index + dir;
                        return layout[next] !== 1;
                     });
                }

                if (validMoves.length > 0) {
                    let bestDir = validMoves[Math.floor(Math.random() * validMoves.length)];
                    
                    if (!ghost.scared) {
                        let target = pacman.index;
                        if (ghost.name === 'pinky') target = pacman.index + (pacman.dir * 4);
                        if (ghost.name === 'clyde') {
                            if(getDistance(ghost.index, pacman.index) < 8) target = 0;
                        }

                        let minDst = Infinity;
                        validMoves.forEach(dir => {
                            let dst = getDistance(ghost.index + dir, target);
                            if (dst < minDst) { minDst = dst; bestDir = dir; }
                        });
                    } else {
                        let maxDst = -1;
                        validMoves.forEach(dir => {
                            let dst = getDistance(ghost.index + dir, pacman.index);
                            if (dst > maxDst) { maxDst = dst; bestDir = dir; }
                        });
                    }
                    
                    ghost.currentDir = bestDir;
                    ghost.index += bestDir;
                }

                if (ghost.index === pacman.index) {
                    if (ghost.scared) ghost.index = ghost.start;
                    else endGame(false);
                }
            }
        });

        drawBoard();
        setTimeout(() => requestAnimationFrame(gameLoop), 50); 
    }

    function drawBoard() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width*TILE_SIZE, width*TILE_SIZE);
        
        layout.forEach((cell, i) => {
            let x = (i % width) * TILE_SIZE;
            let y = Math.floor(i / width) * TILE_SIZE;
            
            if (cell === 1) { 
                ctx.fillStyle = '#1a1a3e';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#334155';
                ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE);
                ctx.strokeStyle = '#ff007f';
                ctx.lineWidth = 1;
                ctx.strokeRect(x+5,y+5,TILE_SIZE-10,TILE_SIZE-10);
            } else if (cell === 0 && !squares[i]) { 
                ctx.fillStyle = '#fbcfe8';
                ctx.beginPath();
                ctx.arc(x+10, y+10, 2, 0, Math.PI*2);
                ctx.fill();
            } else if (cell === 3 && !squares[i]) { 
                ctx.fillStyle = '#ff007f';
                ctx.shadowColor = '#ff007f';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(x+10, y+10, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        });

        // DRAW HEARTMAN
        let px = (pacman.index % width) * TILE_SIZE + 10;
        let py = Math.floor(pacman.index / width) * TILE_SIZE + 10;
        ctx.save();
        ctx.translate(px, py);
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ff3366';
        ctx.font = "20px 'Segoe UI Emoji', Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText('‚ù§Ô∏è', 0, 2);
        ctx.restore();

        // DRAW GLOOMS
        ghosts.forEach(g => {
            let gx = (g.index % width) * TILE_SIZE + 10;
            let gy = Math.floor(g.index / width) * TILE_SIZE + 10;
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = g.color;
            ctx.font = "20px 'Segoe UI Emoji', Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            let emoji = g.scared ? 'ü´•' : g.icon;
            ctx.fillText(emoji, gx, gy + 2);
            ctx.shadowBlur = 0;
        });
    }

    function showHugQuote(text) {
        quotePopup.innerHTML = text;
        quotePopup.classList.add('visible');
        setTimeout(() => {
            quotePopup.classList.remove('visible');
        }, 3000);
    }

    function endGame(win) {
        gameActive = false;
        if(win) {
            // Select random finale quote
            const finalQuote = finaleQuotes[Math.floor(Math.random() * finaleQuotes.length)];
            finalQuoteContainer.innerHTML = `"${finalQuote}"`;
            
            finaleScreen.classList.remove('hidden');
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        } else {
            gameOverScreen.classList.remove('hidden');
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }

    document.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft' || e.key === 'a') pacman.nextDir = -1;
        if(e.key === 'ArrowRight' || e.key === 'd') pacman.nextDir = 1;
        if(e.key === 'ArrowUp' || e.key === 'w') pacman.nextDir = -width;
        if(e.key === 'ArrowDown' || e.key === 's') pacman.nextDir = width;
    });

    let tsX, tsY;
    document.addEventListener('touchstart', e => { tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; }, {passive: false});
    document.addEventListener('touchend', e => {
        let dx = e.changedTouches[0].clientX - tsX;
        let dy = e.changedTouches[0].clientY - tsY;
        if (Math.abs(dx) > 10 || Math.abs(dy) > 10) {
            if(Math.abs(dx) > Math.abs(dy)) pacman.nextDir = dx > 0 ? 1 : -1;
            else pacman.nextDir = dy > 0 ? width : -width;
        }
    }, {passive: false});

    document.getElementById('start-btn').addEventListener('click', () => {
        startScreen.classList.add('hidden');
        musicAudio.play().catch(e => console.log("Audio play failed interaction required"));
        init();
        gameActive = true;
        gameLoop();
    });

    window.addEventListener('resize', () => { if(gameActive) init(); });
</script>

</body>
</html>
