<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEARTMAN: Hug Day Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #ff1493;
            --secondary: #00d4ff;
            --dark-bg: #0a0e27;
            --neon-pink: #ff007f;
            --neon-cyan: #00ffff;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1a0033 50%, #000 100%);
            overflow: hidden;
            touch-action: none;
            user-select: none;
            font-family: 'Press Start 2P', cursive;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Stats Bar */
        .ui-layer {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            font-size: 10px;
            text-shadow: 0 0 5px var(--neon-pink);
            margin-bottom: 5px;
        }
        
        .score-label { color: var(--neon-pink); }
        .goal-label { color: var(--neon-cyan); }

        /* The Game Board */
        canvas {
            border: 4px solid var(--neon-pink);
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.4);
            border-radius: 4px;
            background: #000;
            display: block;
            image-rendering: pixelated;
        }

        /* Controls */
        .bottom-controls {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            justify-content: space-around;
            font-size: 8px;
            color: #aaa;
            text-transform: uppercase;
        }
        .control-item { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .control-icon { font-size: 16px; }

        /* Overlays (Start, Game Over, Finale) */
        .overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            z-index: 50;
            transition: opacity 0.3s;
        }
        
        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }
        
        #start-screen { background: rgba(10, 14, 39, 0.95); }
        #game-over-screen { background: rgba(30, 0, 0, 0.95); }
        #finale-screen { background: #000; border: 4px solid var(--neon-pink); }

        /* Text Styles */
        .title-main {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 8vw, 3.5rem);
            color: var(--neon-pink);
            text-shadow: 4px 4px 0px #550022;
            margin-bottom: 10px;
            text-align: center;
        }
        .title-sub {
            font-size: 0.7rem;
            color: var(--neon-cyan);
            margin-bottom: 30px;
            letter-spacing: 2px;
            text-align: center;
        }
        
        .retro-btn {
            padding: 15px 25px;
            background: #000;
            border: 3px solid var(--neon-pink);
            color: var(--neon-pink);
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 5px 5px 0px rgba(255, 0, 127, 0.4);
            margin-top: 20px;
            text-transform: uppercase;
        }
        .retro-btn:active { transform: translate(2px, 2px); box-shadow: none; }

        /* Finale Heart Animation */
        .pixel-heart-art {
            width: 10px; height: 10px; 
            background: transparent;
            color: var(--neon-pink);
            box-shadow: 20px 0, 50px 0, 10px 10px, 60px 10px, 0 20px, 70px 20px, 0 30px, 70px 30px, 0 40px, 70px 40px, 10px 50px, 60px 50px, 20px 60px, 50px 60px, 30px 70px, 40px 70px;
            transform: scale(3);
            margin-bottom: 50px;
            animation: beat 0.8s infinite alternate;
        }
        @keyframes beat { to { transform: scale(3.3); filter: brightness(1.2); } }

        .finale-text { text-align: center; max-width: 80%; }
        .finale-quote {
            font-size: 0.7rem; color: var(--neon-cyan);
            line-height: 1.6; margin: 20px 0;
            padding: 15px; border: 2px dashed #333;
        }

        /* Powerup Popup */
        #quote-popup {
            position: fixed; top: 10%; left: 50%; transform: translate(-50%, -20px);
            background: #000; color: var(--neon-pink);
            padding: 10px 15px; border: 2px solid var(--neon-pink);
            font-size: 8px; text-align: center; z-index: 100;
            width: 280px; opacity: 0; transition: all 0.3s; pointer-events: none;
        }
        #quote-popup.visible { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-layer">
        <div>SCORE: <span id="score-el">0</span></div>
        <div>GOAL: <span id="target-el">0</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div class="bottom-controls">
        <div class="control-item"><div class="control-icon">üëÜ</div><div>Swipe</div></div>
        <div class="control-item"><div class="control-icon">‚ù§Ô∏è</div><div>Collect</div></div>
        <div class="control-item"><div class="control-icon">‚ö°</div><div>Powerup</div></div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <div class="title-main">HEART<br>MAN</div>
        <div class="title-sub">HUG DAY EDITION</div>
        <div id="enemies-list" style="font-size: 8px; line-height: 2; margin-bottom: 20px;"></div>
        <button id="start-btn" class="retro-btn">INSERT COIN</button>
    </div>

    <div id="game-over-screen" class="overlay-screen hidden">
        <h1 style="color: #ff3333; margin-bottom: 20px;">GAME OVER</h1>
        <p style="font-size: 0.7rem; color: #ccc; margin-bottom: 20px;">The Glooms won.<br>But love never gives up.</p>
        <button class="retro-btn" onclick="location.reload()">TRY AGAIN</button>
    </div>

    <div id="finale-screen" class="overlay-screen hidden">
        <div class="pixel-heart-art"></div>
        <div class="finale-text">
            <h2 style="color: var(--neon-pink);">HAPPY HUG DAY</h2>
            <div id="final-quote-container" class="finale-quote"></div>
            <button class="retro-btn" onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>

    <div id="quote-popup"></div>
</div>

<script>
    // --- 1. GLOBAL VARIABLES & CONFIG ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const width = 28;
    const TILE_SIZE = 20;

    // Game State
    let gameActive = false;
    let score = 0;
    let winningScore = 0;
    let audioCtx = null;
    let melodyInterval = null;
    
    // Player
    let pacman = { 
        index: 490, 
        prevIndex: 490, 
        dir: 0, // 0 = stopped
        nextDir: 0 
    };

    // Level Layout (1=Wall, 0=Dot, 3=Powerup, 4=Empty/GhostHouse)
    const layout = [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,3,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,4,4,4,4,4,4,4,4,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,2,2,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        4,4,4,4,4,4,0,0,0,4,1,2,2,2,2,2,2,1,4,0,0,0,4,4,4,4,4,4,
        1,1,1,1,1,1,0,1,1,4,1,2,2,2,2,2,2,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,1,1,1,1,1,0,1,1,4,1,1,1,1,1,1,1,1,4,1,1,0,1,1,1,1,1,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1,
        1,3,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,3,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,
        1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
    ];
    let squares = new Array(layout.length).fill(false);

    // Ghosts
    let ghosts = [
        { name: 'blinky', index: 348, prevIndex: 348, speed: 130, timer: 0, scared: false, start: 348, color: '#ff1744', displayName: 'STRESS', icon: 'üò°' },
        { name: 'pinky', index: 376, prevIndex: 376, speed: 180, timer: 0, scared: false, start: 376, color: '#ff6ec7', displayName: 'ANXIETY', icon: 'üò∞' },
        { name: 'inky', index: 351, prevIndex: 351, speed: 220, timer: 0, scared: false, start: 351, color: '#9c27b0', displayName: 'DOUBT', icon: 'üòµ‚Äçüí´' },
        { name: 'clyde', index: 379, prevIndex: 379, speed: 280, timer: 0, scared: false, start: 379, color: '#00bcd4', displayName: 'LONELY', icon: 'ü•∫' }
    ];

    // Quotes
    const powerupQuotes = [
        "Imagine me grabbing your bum while we kiss", "Imagine us kissing in the rain",
        "I want to wake up next to you daily", "Your laugh is my favorite sound",
        "You are my safe space", "Every love song is about you",
        "I'd choose you in a hundred lifetimes", "Imagine dancing to jazz in the kitchen",
        "You make the gloomy days sunny", "I am so addicted to you",
        "My heart beats faster near you", "You are the best thing ever",
        "I love you more than pizza", "Imagine a lazy Sunday in sheets",
        "You are my home", "I just want to hold you tight",
        "Even when I'm angry, I love you", "Imagine us growing old flirting",
        "You're the peanut butter to my jelly", "I love it when you smile at me",
        "Imagine late night drives", "You smell like home",
        "I crave your touch constantly", "You are my favorite distraction",
        "I love you to the moon and back", "You are my happy place",
        "Imagine us star gazing", "I love the way you look at me",
        "You're my dream come true", "Imagine breakfast in bed together",
        "I want to steal your hoodies", "You're sweeter than chocolate",
        "I get butterflies seeing you", "Imagine us adopting a puppy",
        "I never want to stop making memories", "Your voice calms my soul",
        "I love your warm hugs", "You are my forever plus one"
    ];

    const finaleQuotes = [
        "No matter how bad the situations are, love always finds a way. I love your hugs.",
        "In your arms is the only place I want to be.", 
        "A hug from you mends all my broken pieces.",
        "Distance means nothing when one hug can change everything.", 
        "I would fight the world just to end the day in your arms.",
        "Your hugs are my anchor in this stormy world.", 
        "One hug from you wipes away a thousand worries.",
        "Home is not a place, it's the feeling of your arms around me.", 
        "I survived the maze of life just to find your embrace.",
        "The best gift you can give me is a tight hug that lasts forever.", 
        "My favorite place in the universe? Right next to you.",
        "Through every gloom and every fear, I choose you.", 
        "You are the pause button on my chaotic life.",
        "Let's stay tangled in a hug until the world ends.", 
        "Your heartbeat is the rhythm I want to fall asleep to.",
        "Nothing feels as safe as being held by you.", 
        "I gathered all this love just to give it to you.",
        "A hug is a handshake from the heart, and my heart is yours.", 
        "You are the warmth in my coldest winters.",
        "Here's to a lifetime of hugs, laughter, and us."
    ];
    let sessionQuotes = [];

    // --- 2. AUDIO SYSTEM (Procedural = No External Files) ---
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        // Simple Synthwave Bassline Arpeggio
        const notes = [130.81, 155.56, 196.00, 155.56, 130.81, 116.54, 155.56, 116.54]; // C3 scale
        let noteIdx = 0;

        if (melodyInterval) clearInterval(melodyInterval);
        
        melodyInterval = setInterval(() => {
            if(!gameActive) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(notes[noteIdx % notes.length], audioCtx.currentTime);
            
            // Filter for retro sound
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800;
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
            noteIdx++;
        }, 200); // Speed of music
    }

    // --- 3. GAME LOGIC ---

    function initGame() {
        // Resize Canvas
        const h = window.innerHeight * 0.65;
        const w = window.innerWidth * 0.95;
        const scale = Math.min(w / (width * TILE_SIZE), h / (width * TILE_SIZE));
        canvas.width = width * TILE_SIZE * scale;
        canvas.height = width * TILE_SIZE * scale;
        ctx.scale(scale, scale);

        // Reset Variables
        pacman = { index: 490, prevIndex: 490, dir: 0, nextDir: 0 };
        squares = new Array(layout.length).fill(false);
        score = 0;
        
        // Calc Winning Score
        winningScore = 0;
        layout.forEach(c => { if(c===0) winningScore++; if(c===3) winningScore+=50; });
        document.getElementById('target-el').innerText = winningScore;
        document.getElementById('score-el').innerText = 0;
        
        // Reset Ghosts
        ghosts.forEach(g => {
            g.index = g.start;
            g.prevIndex = g.start;
            g.scared = false;
        });

        // Quotes
        sessionQuotes = [...powerupQuotes].sort(() => 0.5 - Math.random()).slice(0, 4);

        // Populate Start Screen List
        const list = document.getElementById('enemies-list');
        list.innerHTML = '';
        ghosts.forEach(g => {
            list.innerHTML += `<div style="color:${g.color}">${g.icon} ${g.displayName}</div>`;
        });
    }

    function gameLoop() {
        if (!gameActive) return;

        // 1. Pacman Movement
        let moveIdx = pacman.index;
        if (pacman.nextDir !== 0) {
            let nextPos = pacman.index + pacman.nextDir;
            if (layout[nextPos] !== 1 && layout[nextPos] !== 2) {
                pacman.dir = pacman.nextDir;
            }
        }
        
        if (pacman.dir !== 0) {
            let nextPos = pacman.index + pacman.dir;
            if (layout[nextPos] !== 1 && layout[nextPos] !== 2) {
                pacman.prevIndex = pacman.index;
                pacman.index = nextPos;
            }
        }

        // Tunnel handling
        if (pacman.index === 392) pacman.index = 419;
        else if (pacman.index === 419) pacman.index = 392;

        // 2. Eating
        if (layout[pacman.index] === 0 && !squares[pacman.index]) {
            score++;
            squares[pacman.index] = true;
            document.getElementById('score-el').innerText = score;
        } else if (layout[pacman.index] === 3 && !squares[pacman.index]) {
            score += 50;
            squares[pacman.index] = true;
            document.getElementById('score-el').innerText = score;
            triggerPowerup();
        }

        if (score >= winningScore) { endGame(true); return; }

        // 3. Ghost AI
        ghosts.forEach(g => {
            g.timer++;
            let thresh = g.scared ? 15 : 6; // Slower ghosts for playability
            
            if (g.timer > thresh) {
                g.timer = 0;
                const dirs = [-1, 1, -width, width];
                
                // Valid moves (not wall, and don't reverse unless stuck)
                let valid = dirs.filter(d => {
                    let next = g.index + d;
                    return layout[next] !== 1 && (g.scared || d !== -g.currentDir); 
                });

                if (valid.length === 0) valid = dirs.filter(d => layout[g.index+d] !== 1);

                if (valid.length > 0) {
                    let best = valid[Math.floor(Math.random() * valid.length)];
                    
                    if (!g.scared) {
                        // Chase Logic
                        let t = pacman.index;
                        // Pinky aims ahead
                        if(g.name === 'pinky') t += pacman.dir * 4;
                        
                        let minDst = Infinity;
                        valid.forEach(d => {
                            let cx = (g.index+d)%width, cy = Math.floor((g.index+d)/width);
                            let tx = t%width, ty = Math.floor(t/width);
                            let dst = Math.sqrt((cx-tx)**2 + (cy-ty)**2);
                            if(dst < minDst) { minDst = dst; best = d; }
                        });
                    }
                    g.prevIndex = g.index;
                    g.index += best;
                    g.currentDir = best; // Store current direction to prevent jitter
                }
            }
            
            // 4. Collision (Pass-Through Logic)
            let hit = (g.index === pacman.index) || (g.index === pacman.prevIndex && g.prevIndex === pacman.index);
            
            if (hit) {
                if (g.scared) {
                    g.index = g.start;
                } else {
                    endGame(false);
                }
            }
        });

        draw();
        requestAnimationFrame(gameLoop);
    }

    function triggerPowerup() {
        let text = sessionQuotes.length > 0 ? sessionQuotes.pop() : "Bonus Love!";
        const p = document.getElementById('quote-popup');
        p.innerText = text;
        p.classList.add('visible');
        setTimeout(() => p.classList.remove('visible'), 3000);
        
        ghosts.forEach(g => g.scared = true);
        setTimeout(() => ghosts.forEach(g => g.scared = false), 8000);
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function draw() {
        // Clear
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Map
        layout.forEach((cell, i) => {
            let x = (i % width) * TILE_SIZE;
            let y = Math.floor(i / width) * TILE_SIZE;
            
            if (cell === 1) {
                ctx.fillStyle = '#1a1a3e';
                ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#ff007f';
                ctx.lineWidth = 1;
                ctx.strokeRect(x+4, y+4, TILE_SIZE-8, TILE_SIZE-8);
            } else if (cell === 0 && !squares[i]) {
                ctx.fillStyle = '#fbcfe8';
                ctx.beginPath(); ctx.arc(x+10, y+10, 2, 0, 6.28); ctx.fill();
            } else if (cell === 3 && !squares[i]) {
                ctx.fillStyle = '#ff007f';
                ctx.beginPath(); ctx.arc(x+10, y+10, 6, 0, 6.28); ctx.fill();
            }
        });

        // Pacman
        let px = (pacman.index % width) * TILE_SIZE + 10;
        let py = Math.floor(pacman.index / width) * TILE_SIZE + 10;
        ctx.font = "20px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText('‚ù§Ô∏è', px, py+2);

        // Ghosts
        ghosts.forEach(g => {
            let gx = (g.index % width) * TILE_SIZE + 10;
            let gy = Math.floor(g.index / width) * TILE_SIZE + 10;
            ctx.fillText(g.scared ? 'ü´•' : g.icon, gx, gy+2);
        });
    }

    function endGame(win) {
        gameActive = false;
        clearInterval(melodyInterval);
        
        if (win) {
            document.getElementById('finale-screen').classList.remove('hidden');
            let q = finaleQuotes[Math.floor(Math.random() * finaleQuotes.length)];
            document.getElementById('final-quote-container').innerText = `"${q}"`;
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        } else {
            document.getElementById('game-over-screen').classList.remove('hidden');
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }

    // --- 4. CONTROLS & INIT ---
    
    // Start Button
    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-screen').classList.add('hidden');
        initGame();
        initAudio();
        gameActive = true;
        requestAnimationFrame(gameLoop);
    });

    // Keyboard
    document.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft') pacman.nextDir = -1;
        if(e.key === 'ArrowRight') pacman.nextDir = 1;
        if(e.key === 'ArrowUp') pacman.nextDir = -width;
        if(e.key === 'ArrowDown') pacman.nextDir = width;
    });

    // Touch
    let tsX, tsY;
    document.addEventListener('touchstart', e => { 
        // Only prevent default if touching canvas area to allow button clicks
        if(e.target.tagName !== 'BUTTON') e.preventDefault();
        tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; 
    }, {passive: false});
    
    document.addEventListener('touchend', e => {
        let dx = e.changedTouches[0].clientX - tsX;
        let dy = e.changedTouches[0].clientY - tsY;
        if(Math.abs(dx) > 20 || Math.abs(dy) > 20) {
            if(Math.abs(dx) > Math.abs(dy)) pacman.nextDir = dx > 0 ? 1 : -1;
            else pacman.nextDir = dy > 0 ? width : -width;
        }
    }, {passive: false});

    // Initial setup on load
    initGame();
</script>

</body>
</html>
